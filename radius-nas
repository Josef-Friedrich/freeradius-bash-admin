#! /bin/bash

. /etc/freeradius-bash-admin.conf

_value() {
  local COLUMN="$1"

  _mysql_silent "
    SELECT
      $COLUMN
      FROM nas
      WHERE id = '$ID';
  "
}

_add() {
  _prompt IP "IP address"
  _prompt SHORT_NAME "Short name"
  _prompt DESCRIPTION "Description"
  _prompt SECRET "Secret" $(_password_generator)
  
  _mysql "
    INSERT
      INTO nas (nasname, shortname, secret, description)
      VALUES ('$IP','$SHORT_NAME','$SECRET', '$DESCRIPTION');
  "
}

_show() {
  local ID="$1"

  if [ -z $ID ]; then
    echo "Usage: radius-nas show <id> or <all>"
    exit 1
  fi

  if [ "$ID" != 'all' ]; then
    local WHERE="WHERE id = '$ID'"    
  fi

  _mysql "
    SELECT 

      id as ID, 
      shortname as Shortname, 
      secret AS Secret, 
      nasname AS 'IP address',
      description AS Description

      FROM nas
      $WHERE;
  "
}

_update() {
  local ID="$1"

  if [ -z "$ID" ] ; then
     echo "Usage: radius-nas update <id>"
     exit 1
  fi
  _prompt SHORT_NAME "Short name" "$(_value shortname)"
  _prompt SECRET "Secret" "$(_value secret)"
  _prompt IP "IP address" "$(_value nasname)"
  _prompt DESCRIPTION "Description" "$(_value description)"

  _mysql "
    UPDATE nas
      SET 
        nasname = '$IP',
        shortname = '$SHORT_NAME',
        secret = '$SECRET',
        description = '$DESCRIPTION'
      WHERE id = '$ID';
  "

  _show "$ID"
}

_delete() {
  local ID="$1"

  if [ -z "$ID" ]; then
    echo "Usage: radius-nas delete <id>"
    exit 1
  fi

  _prompt_yes "Delete nas (id: '$ID')?"

  _mysql "
    DELETE
      FROM nas
      WHERE id = '$ID';
  "
}

_usage() {
  echo "Usage: radius-nas <options>

Options:

  add                 : Add nas.
  show <id> or <all>  : Show nas.
  update <id>         : Update nas.
  delete <id>         : Delete nas by ID.
  help                : Display help topics.
"
}

case "$1" in

  add)
    shift 1
    _add $@
    ;;

  show)
    shift 1
    _show $@
    ;;

  update)
    shift 1
    _update $@
    ;;

  delete)
    shift 1
    _delete $@
    ;;

  help)
    _usage
    ;;

  *)
    _usage
    ;;

esac

# vim: set ts=2 sw=2 sts=2 et :